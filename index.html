<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å­¸ç”Ÿè€ƒè©¦é¢¨éšªè©•ä¼°ç³»çµ± (AI æ™ºèƒ½ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans TC', sans-serif; }
        .risk-bar-container { background-color: #e5e7eb; border-radius: 9999px; height: 12px; overflow: hidden; }
        .risk-bar-fill { height: 100%; transition: width 0.5s ease-in-out; }
        .markdown-body ul { list-style-type: disc; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-body ol { list-style-type: decimal; padding-left: 1.5rem; margin-top: 0.5rem; margin-bottom: 0.5rem; }
        .markdown-body strong { font-weight: 700; color: #4338ca; } /* Indigo-700 */
        .markdown-body h3 { font-size: 1.1em; font-weight: bold; margin-top: 1em; margin-bottom: 0.5em; color: #1e1b4b; }
        
        /* Modal å‹•ç•« */
        .modal { transition: opacity 0.25s ease; }
        body.modal-active { overflow-x: hidden; overflow-y: visible !important; }

        /* èƒŒæ™¯å‹•ç•« Keyframes */
        @keyframes blob {
            0% { transform: translate(0px, 0px) scale(1); }
            33% { transform: translate(30px, -50px) scale(1.1); }
            66% { transform: translate(-20px, 20px) scale(0.9); }
            100% { transform: translate(0px, 0px) scale(1); }
        }
        .animate-blob {
            animation: blob 7s infinite;
        }
        .animation-delay-2000 {
            animation-delay: 2s;
        }
        .animation-delay-4000 {
            animation-delay: 4s;
        }
    </style>
</head>
<!-- ä¿®æ”¹èƒŒæ™¯ç‚ºæ¼¸å±¤ï¼Œä¸¦è¨­ç½® relative ä»¥å®¹ç´èƒŒæ™¯å‹•ç•« -->
<body class="bg-gradient-to-br from-blue-50 via-indigo-50 to-purple-50 min-h-screen flex items-center justify-center p-4 relative overflow-x-hidden">

    <!-- è£é£¾æ€§èƒŒæ™¯å‹•ç•« (Blobs) -->
    <div class="absolute top-0 -left-4 w-72 h-72 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob"></div>
    <div class="absolute top-0 -right-4 w-72 h-72 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-2000"></div>
    <div class="absolute -bottom-8 left-20 w-72 h-72 bg-pink-300 rounded-full mix-blend-multiply filter blur-xl opacity-70 animate-blob animation-delay-4000"></div>

    <div class="bg-white/90 backdrop-blur-sm max-w-2xl w-full rounded-2xl shadow-2xl overflow-hidden relative z-10 border border-white/20">
        
        <!-- API Key è¨­å®šæŒ‰éˆ• (å³ä¸Šè§’) -->
        <button onclick="toggleModal('apiKeyModal')" class="absolute top-4 right-4 text-white/80 hover:text-white hover:bg-white/20 p-2 rounded-lg transition z-10" title="è¨­å®š API Key">
            <i class="fa-solid fa-gear text-lg"></i>
        </button>

        <!-- Header -->
        <div class="bg-indigo-600 p-6 text-white text-center shadow-md">
            <h1 class="text-2xl font-bold mb-2"><i class="fa-solid fa-robot mr-2"></i>å­¸ç”Ÿè€ƒè©¦é¢¨éšªè©•ä¼° (AI æ™ºèƒ½ç‰ˆ)</h1>
            <p class="text-indigo-100 text-sm">çµåˆ Gemini è¦–è¦ºè¾¨è­˜åŠæ•¸æ“šåŒ–é¡¯ç¤ºéŒ¯é¡Œè¨ºæ–·èˆ‡ç­–ç•¥åˆ†æ</p>
        </div>

        <div class="p-6 md:p-8 space-y-6">
            <!-- è¼¸å…¥è¡¨å–® -->
            <div id="inputForm" class="space-y-4">
                <!-- æç¤ºè‡ªå‹•å„²å­˜ç‹€æ…‹ -->
                <div class="flex justify-end">
                    <span id="saveStatus" class="text-xs text-gray-500 opacity-0 transition-opacity duration-500 font-medium"><i class="fa-solid fa-check mr-1"></i>å·²è‡ªå‹•å„²å­˜</span>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">è€ƒè©¦ç§‘ç›®</label>
                        <select id="subject" onchange="autoSave()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-white/50 hover:bg-white">
                            <option value="åœ‹æ–‡">åœ‹æ–‡</option>
                            <option value="è‹±æ–‡">è‹±æ–‡</option>
                            <option value="æ•¸å­¸" selected>æ•¸å­¸</option>
                            <option value="ç‰©ç†">ç‰©ç†</option>
                            <option value="åŒ–å­¸">åŒ–å­¸</option>
                            <option value="ç”Ÿç‰©">ç”Ÿç‰©</option>
                            <option value="åœ°çƒç§‘å­¸">åœ°çƒç§‘å­¸</option>
                            <option value="åœ°ç†">åœ°ç†</option>
                            <option value="æ­·å²">æ­·å²</option>
                            <option value="å…¬æ°‘">å…¬æ°‘</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ç›®æ¨™åˆ†æ•¸ (0-100)</label>
                        <input type="number" id="targetScore" oninput="autoSave()" placeholder="0-100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 hover:bg-white transition" min="0" max="100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">ä¸Šæ¬¡å¤§è€ƒåˆ†æ•¸ (0-100)</label>
                        <input type="number" id="pastScore" oninput="autoSave()" placeholder="0-100" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 hover:bg-white transition" min="0" max="100">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">å¹³å¸¸å°è€ƒåˆ†æ•¸</label>
                        <input type="text" id="quizScore" oninput="autoSave()" placeholder="è¼¸å…¥å–®ä¸€åˆ†æ•¸ æˆ– å¦‚: 80, 65, 90" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 hover:bg-white transition">
                        <p class="text-xs text-gray-500 mt-1 ml-1"><i class="fa-solid fa-wand-magic-sparkles mr-1"></i>æ”¯æ´å¤šç­†è¼¸å…¥(é€—è™Ÿåˆ†éš”)ï¼Œè‡ªå‹•ç®—å¹³å‡</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æ¯æ—¥è®€æ›¸æ™‚é–“ (0-24å°æ™‚)</label>
                        <input type="number" id="dailyStudy" oninput="autoSave()" placeholder="ä¾‹å¦‚ï¼š2.5" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 hover:bg-white transition" min="0" max="24" step="0.5">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">æœªä¾†è€ƒè©¦æ—¥æœŸ</label>
                        <input type="date" id="examDate" onchange="autoSave()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none bg-white/50 hover:bg-white transition">
                    </div>
                    <!-- è®€æ›¸ç¿’æ…£æ¬„ä½ -->
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-1">å€‹äººè®€æ›¸ç¿’æ…£ (æ•ˆç‡è©•ä¼°)</label>
                        <select id="studyHabit" onchange="autoSave()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition bg-white/50 hover:bg-white">
                            <option value="0.0">ğŸŒŸ éå¸¸è‡ªå¾‹ (å°ˆæ³¨åŠ›æ¥µé«˜ï¼Œå®Œå…¨ä¸åˆ†å¿ƒ)</option>
                            <option value="0.3">ğŸ‘ æŒ‰è¡¨æ“èª² (æœ‰è¨ˆç•«ï¼Œå¶çˆ¾æ‰åˆ†å¿ƒ)</option>
                            <option value="0.6" selected>ğŸ˜ æ™®é€š (å®¹æ˜“è¢«æ‰‹æ©Ÿå½±éŸ¿ï¼Œè®€è®€åœåœ)</option>
                            <option value="0.9">âš ï¸ åš´é‡æ‹–å»¶ (å¾ˆé›£é€²å…¥ç‹€æ³ï¼Œæ•ˆç‡ä½è½)</option>
                        </select>
                    </div>

                    <!-- æ–°å¢ï¼šéŒ¯é¡Œä¸Šå‚³å€ -->
                    <div class="md:col-span-2 border-t border-dashed border-gray-300 pt-4 mt-2">
                        <label class="block text-sm font-bold text-indigo-700 mb-2">
                            <i class="fa-solid fa-camera mr-1"></i> ä¸Šå‚³éŒ¯é¡Œ (é¸å¡«)
                            <span class="text-xs font-normal text-gray-500 ml-1">- è®“ AI å¹«æ‚¨åˆ†æå¼±é»ä¸¦æ‰¾å‡ºè¤‡ç¿’é‡é»</span>
                        </label>
                        <div class="flex flex-col space-y-3">
                            <div class="flex items-center space-x-4">
                                <label class="cursor-pointer bg-white border border-gray-300 hover:bg-gray-50 hover:border-indigo-300 text-gray-700 py-2 px-4 rounded-lg shadow-sm transition duration-200 flex items-center group">
                                    <i class="fa-solid fa-upload mr-2 text-indigo-500 group-hover:scale-110 transition-transform"></i> 
                                    <span>é¸æ“‡åœ–ç‰‡</span>
                                    <input type="file" id="wrongQuestionImg" accept="image/*" class="hidden" onchange="handleImageUpload(this)">
                                </label>
                                <span id="fileName" class="text-sm text-gray-500 truncate max-w-[200px]">æœªé¸æ“‡æª”æ¡ˆ</span>
                                <button id="clearImgBtn" onclick="clearImage()" class="hidden text-xs text-red-500 hover:text-red-700 underline">ç§»é™¤</button>
                            </div>
                            <div id="imagePreview" class="hidden relative w-fit">
                                <img src="" alt="éŒ¯é¡Œé è¦½" class="max-h-48 rounded-lg border border-gray-200 shadow-md">
                                <div class="absolute bottom-2 right-2 bg-black bg-opacity-60 text-white text-xs px-2 py-1 rounded">
                                    æº–å‚™åˆ†æ
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <button onclick="calculateRisk()" class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-bold py-3 rounded-lg shadow-md hover:shadow-lg transition duration-200 mt-4 flex justify-center items-center transform hover:-translate-y-0.5">
                    <i class="fa-solid fa-calculator mr-2"></i> é–‹å§‹ç²¾æº–è©•ä¼°
                </button>
            </div>

            <!-- éŒ¯èª¤è¨Šæ¯ -->
            <div id="errorMessage" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 rounded shadow-sm" role="alert">
                <p class="font-bold">è¼¸å…¥éŒ¯èª¤</p>
                <p id="errorText">è«‹æª¢æŸ¥æ‰€æœ‰æ¬„ä½æ˜¯å¦å·²æ­£ç¢ºå¡«å¯«ã€‚</p>
            </div>

            <!-- çµæœé¡¯ç¤ºå€ -->
            <div id="resultSection" class="hidden animate-fade-in space-y-6">
                <div class="border-t border-gray-200 pt-6"></div>
                
                <!-- é ‚éƒ¨ç¸½çµ -->
                <div class="flex flex-col md:flex-row items-center justify-between bg-gray-50 p-4 rounded-xl border border-gray-200 shadow-sm">
                    <div class="mb-4 md:mb-0 text-center md:text-left">
                        <h2 class="text-xl font-bold text-gray-800" id="resultTitle">æ•¸å­¸ é¢¨éšªå ±å‘Š</h2>
                        <p class="text-gray-600 text-sm mt-1">
                            <i class="fa-regular fa-calendar mr-1"></i> è·é›¢è€ƒè©¦é‚„æœ‰ <span id="daysLeftDisplay" class="font-bold text-indigo-600">0</span> å¤©
                        </p>
                    </div>
                    <div class="text-center">
                        <div class="text-sm text-gray-500 mb-1">ç¸½é«”é¢¨éšªæŒ‡æ•¸</div>
                        <div id="totalRiskDisplay" class="text-4xl font-black text-gray-800">0%</div>
                        <div id="riskLevelBadge" class="inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 bg-gray-200 text-gray-700">è¨ˆç®—ä¸­</div>
                    </div>
                </div>

                <!-- è©³ç´°æ•¸æ“š -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <!-- æ•¸æ“šå¡ç‰‡ -->
                    <div class="bg-white border border-gray-200 p-4 rounded-xl shadow-sm hover:shadow-md transition">
                        <h3 class="font-bold text-gray-700 mb-3 border-b pb-2">ğŸ“Š æ•¸æ“šåˆ†æ</h3>
                        <div class="space-y-3 text-sm">
                            <div class="flex justify-between">
                                <span class="text-gray-600">åˆ†æ•¸å·®è· (ç›®æ¨™-å¤§è€ƒ)</span>
                                <span class="font-bold text-gray-800" id="scoreGapDisplay">0 åˆ†</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">é ä¼°æ‰€éœ€æ™‚æ•¸</span>
                                <span class="font-bold text-blue-600" id="neededHoursDisplay">0 hr</span>
                            </div>
                            <div class="flex justify-between">
                                <span class="text-gray-600">é è¨ˆæŠ•å…¥æ™‚æ•¸</span>
                                <span class="font-bold text-green-600" id="potentialHoursDisplay">0 hr</span>
                            </div>
                            <div class="flex justify-between pt-2 border-t border-dashed">
                                <span class="text-gray-600">æ™‚é–“ç‹€æ…‹</span>
                                <span class="font-bold" id="timeStatusDisplay">è¨ˆç®—ä¸­</span>
                            </div>
                        </div>
                    </div>

                    <!-- ç³»çµ±å»ºè­°å¡ç‰‡ -->
                    <div class="bg-indigo-50 border border-indigo-100 p-4 rounded-xl shadow-sm hover:shadow-md transition">
                        <h3 class="font-bold text-indigo-800 mb-3 border-b border-indigo-200 pb-2">ğŸ’¡ ç³»çµ±åˆæ­¥å»ºè­°</h3>
                        <p id="adviceText" class="text-sm text-indigo-900 leading-relaxed">
                            è«‹è¼¸å…¥è³‡æ–™ä»¥ç²å–å»ºè­°ã€‚
                        </p>
                    </div>
                </div>

                <!-- é¢¨éšªå› å­é•·æ¢åœ– -->
                <div>
                    <h3 class="font-bold text-gray-700 mb-3">ğŸ” é¢¨éšªå› å­ç´°é … (è¶Šé•·è¶Šå±éšª)</h3>
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>åŸºç¤èƒ½åŠ›å·®è· (35%)</span>
                                <span id="valPast">0%</span>
                            </div>
                            <div class="risk-bar-container">
                                <div id="barPast" class="risk-bar-fill bg-blue-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>å°è€ƒæŒæ¡åº¦ (25%)</span>
                                <span id="valQuiz">0%</span>
                            </div>
                            <div class="risk-bar-container">
                                <div id="barQuiz" class="risk-bar-fill bg-teal-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>æ™‚é–“æŠ•å…¥ä¸è¶³ (15%)</span>
                                <span id="valStudy">0%</span>
                            </div>
                            <div class="risk-bar-container">
                                <div id="barStudy" class="risk-bar-fill bg-yellow-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>å­¸ç¿’æ•ˆç‡é¢¨éšª (15%)</span>
                                <span id="valHabit">0%</span>
                            </div>
                            <div class="risk-bar-container">
                                <div id="barHabit" class="risk-bar-fill bg-purple-500" style="width: 0%"></div>
                            </div>
                        </div>
                        <div>
                            <div class="flex justify-between text-xs mb-1">
                                <span>è€ƒå‰æ™‚é–“ç·Šè¿« (10%)</span>
                                <span id="valTime">0%</span>
                            </div>
                            <div class="risk-bar-container">
                                <div id="barTime" class="risk-bar-fill bg-red-500" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Gemini AI æ•´åˆå€åŸŸ -->
                <div id="aiSection" class="mt-8 border-t border-gray-200 pt-8">
                    <div class="bg-gradient-to-br from-indigo-50 to-purple-50 rounded-xl p-6 border border-indigo-100 shadow-sm">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-lg font-bold text-indigo-900">
                                <i class="fa-solid fa-wand-magic-sparkles text-yellow-500 mr-2"></i>AI æ™ºèƒ½å‚™è€ƒæ•™ç·´
                            </h3>
                            <span id="imgStatusBadge" class="hidden bg-blue-100 text-blue-800 text-xs font-semibold mr-2 px-2.5 py-0.5 rounded border border-blue-400">
                                <i class="fa-solid fa-image mr-1"></i>å·²åŒ…å«éŒ¯é¡Œåˆ†æ
                            </span>
                        </div>
                        <p class="text-sm text-gray-600 mb-4">
                            è¦ºå¾—è¿·æƒ˜å—ï¼Ÿè®“ AI æ ¹æ“šæ‚¨çš„åˆ†æ•¸ã€å‰©é¤˜å¤©æ•¸ã€è®€æ›¸ç¿’æ…£<span id="aiPromptImgHint" class="hidden text-indigo-600 font-bold">ä»¥åŠæ‚¨ä¸Šå‚³çš„éŒ¯é¡Œ</span>ï¼Œç‚ºæ‚¨é‡èº«æ‰“é€ å…·é«”çš„æ¶åˆ†ç­–ç•¥ã€‚
                        </p>
                        
                        <!-- ç”ŸæˆæŒ‰éˆ• -->
                        <button onclick="generateAIAdvice()" id="aiBtn" class="w-full bg-white hover:bg-gray-50 text-indigo-600 font-bold py-3 px-4 rounded-lg border-2 border-indigo-200 shadow-sm transition duration-200 flex items-center justify-center group">
                            <span id="aiBtnText" class="flex items-center">
                                <i class="fa-solid fa-brain mr-2 group-hover:animate-pulse"></i> å–å¾— AI ç›´æ¥å»ºè­°èˆ‡ç­–ç•¥
                            </span>
                            <div id="aiLoading" class="hidden flex items-center">
                                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-indigo-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                                </svg>
                                AI æ­£åœ¨ç‚ºæ‚¨è¦åŠƒ...<span id="loadingImgText" class="hidden">(å«éŒ¯é¡Œè§£æ)</span>
                            </div>
                        </button>

                        <!-- AI å›æ‡‰é¡¯ç¤ºå€ -->
                        <div id="aiResponse" class="hidden mt-4 bg-white p-5 rounded-lg border border-indigo-100 text-gray-800 text-sm leading-relaxed markdown-body shadow-inner">
                            <!-- å…§å®¹å°‡ç”± JS å¡«å…¥ -->
                        </div>
                    </div>
                </div>

                <!-- é‡æ–°è©•ä¼°æŒ‰éˆ• -->
                <div class="mt-6 text-center pt-6">
                    <button onclick="resetAssessment()" class="text-gray-500 hover:text-gray-700 font-medium text-sm flex items-center justify-center mx-auto transition duration-200">
                        <i class="fa-solid fa-rotate-left mr-1"></i> æ¸…é™¤è³‡æ–™ä¸¦é‡æ–°è©•ä¼°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="apiKeyModal" class="modal opacity-0 pointer-events-none fixed w-full h-full top-0 left-0 flex items-center justify-center z-50">
        <div class="modal-overlay absolute w-full h-full bg-gray-900 opacity-50" onclick="toggleModal('apiKeyModal')"></div>
        
        <div class="modal-container bg-white w-11/12 md:max-w-md mx-auto rounded shadow-lg z-50 overflow-y-auto">
            <div class="modal-content py-4 text-left px-6">
                <!-- Title -->
                <div class="flex justify-between items-center pb-3">
                    <p class="text-2xl font-bold text-gray-800">âš™ï¸ è¨­å®š Gemini API Key</p>
                    <div class="modal-close cursor-pointer z-50" onclick="toggleModal('apiKeyModal')">
                        <i class="fa-solid fa-xmark text-gray-500 hover:text-gray-700"></i>
                    </div>
                </div>

                <!-- Body -->
                <div class="my-5">
                    <p class="text-sm text-gray-600 mb-2">è«‹è¼¸å…¥æ‚¨çš„ Google Gemini API Key ä»¥å•Ÿç”¨ AI åŠŸèƒ½ã€‚æ‚¨çš„ Key åƒ…æœƒå„²å­˜åœ¨æ‚¨çš„ç€è¦½å™¨ä¸­ï¼Œä¸æœƒä¸Šå‚³åˆ°ä»»ä½•ä¼ºæœå™¨ã€‚</p>
                    <input type="password" id="apiKeyInput" placeholder="è²¼ä¸Šæ‚¨çš„ API Key (ä¾‹å¦‚ AIzaSy...)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 outline-none">
                    <p class="text-xs text-indigo-500 mt-2 hover:underline"><a href="https://aistudio.google.com/app/apikey" target="_blank">ğŸ‘‰ æŒ‰æ­¤å…è²»ç”³è«‹ API Key</a></p>
                </div>

                <!-- Footer -->
                <div class="flex justify-end pt-2">
                    <button onclick="saveApiKey()" class="px-4 py-2 bg-indigo-600 text-white font-medium rounded-lg hover:bg-indigo-700 mr-2">å„²å­˜è¨­å®š</button>
                    <button onclick="toggleModal('apiKeyModal')" class="px-4 py-2 bg-gray-100 text-gray-600 font-medium rounded-lg hover:bg-gray-200">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // åˆå§‹åŒ–è¼‰å…¥
        window.onload = function() {
            // è¼‰å…¥ API Key
            const savedKey = localStorage.getItem('gemini_api_key');
            if (savedKey) {
                document.getElementById('apiKeyInput').value = savedKey;
            }

            // è¼‰å…¥è¡¨å–®è³‡æ–™
            loadFormData();

            // è¨­å®šé è¨­æ—¥æœŸ (è‹¥æ²’å­˜é)
            if (!document.getElementById('examDate').value) {
                const today = new Date();
                const futureDate = new Date(today);
                futureDate.setDate(today.getDate() + 30);
                document.getElementById('examDate').valueAsDate = futureDate;
            }
        };

        // --- Auto Save Logic ---
        function autoSave() {
            const formData = {
                subject: document.getElementById('subject').value,
                targetScore: document.getElementById('targetScore').value,
                pastScore: document.getElementById('pastScore').value,
                quizScore: document.getElementById('quizScore').value,
                dailyStudy: document.getElementById('dailyStudy').value,
                examDate: document.getElementById('examDate').value,
                studyHabit: document.getElementById('studyHabit').value
            };
            localStorage.setItem('exam_risk_data', JSON.stringify(formData));
            
            // é¡¯ç¤ºå„²å­˜æç¤º
            const status = document.getElementById('saveStatus');
            status.classList.remove('opacity-0');
            setTimeout(() => {
                status.classList.add('opacity-0');
            }, 2000);
        }

        function loadFormData() {
            const savedData = localStorage.getItem('exam_risk_data');
            if (savedData) {
                const data = JSON.parse(savedData);
                if(data.subject) document.getElementById('subject').value = data.subject;
                if(data.targetScore) document.getElementById('targetScore').value = data.targetScore;
                if(data.pastScore) document.getElementById('pastScore').value = data.pastScore;
                if(data.quizScore) document.getElementById('quizScore').value = data.quizScore;
                if(data.dailyStudy) document.getElementById('dailyStudy').value = data.dailyStudy;
                if(data.examDate) document.getElementById('examDate').value = data.examDate;
                if(data.studyHabit) document.getElementById('studyHabit').value = data.studyHabit;
            }
        }

        // --- API Key Modal Logic ---
        function toggleModal(modalID) {
            document.getElementById(modalID).classList.toggle("opacity-0");
            document.getElementById(modalID).classList.toggle("pointer-events-none");
            document.body.classList.toggle("modal-active");
        }

        function saveApiKey() {
            const key = document.getElementById('apiKeyInput').value.trim();
            if (key) {
                localStorage.setItem('gemini_api_key', key);
                alert("API Key å·²å„²å­˜ï¼æ‚¨å¯ä»¥é–‹å§‹ä½¿ç”¨ AI åŠŸèƒ½äº†ã€‚");
                toggleModal('apiKeyModal');
            } else {
                alert("è«‹è¼¸å…¥æœ‰æ•ˆçš„ API Keyã€‚");
            }
        }

        function getApiKey() {
            return localStorage.getItem('gemini_api_key') || "";
        }

        // --- å…¨åŸŸè®Šæ•¸ ---
        let currentAssessmentData = null;
        let currentImageBase64 = null;
        let currentImageMimeType = null;

        // --- åœ–ç‰‡è™•ç†å‡½å¼ ---
        function handleImageUpload(input) {
            const file = input.files[0];
            if (file) {
                if (file.size > 5 * 1024 * 1024) { 
                    alert("åœ–ç‰‡æª”æ¡ˆéå¤§ï¼Œè«‹é¸æ“‡å°æ–¼ 5MB çš„åœ–ç‰‡ã€‚");
                    input.value = ""; 
                    return;
                }
                document.getElementById('fileName').innerText = file.name;
                document.getElementById('clearImgBtn').classList.remove('hidden');
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const preview = document.getElementById('imagePreview');
                    preview.classList.remove('hidden');
                    preview.querySelector('img').src = e.target.result;
                    currentImageBase64 = e.target.result.split(',')[1];
                    currentImageMimeType = file.type;
                };
                reader.readAsDataURL(file);
            }
        }

        function clearImage() {
            document.getElementById('wrongQuestionImg').value = "";
            document.getElementById('fileName').innerText = "æœªé¸æ“‡æª”æ¡ˆ";
            document.getElementById('imagePreview').classList.add('hidden');
            document.getElementById('clearImgBtn').classList.add('hidden');
            currentImageBase64 = null;
            currentImageMimeType = null;
        }

        // --- è¨ˆç®—é‚è¼¯ ---
        function calculateRisk() {
            const subject = document.getElementById('subject').value || "æœªå‘½åç§‘ç›®";
            const target = parseFloat(document.getElementById('targetScore').value);
            const past = parseFloat(document.getElementById('pastScore').value);
            
            const quizInput = document.getElementById('quizScore').value;
            let quiz = NaN;

            if (quizInput && quizInput.trim() !== "") {
                const scores = quizInput.split(/[,ï¼Œ\s]+/).filter(s => s.trim() !== "").map(Number);
                if (scores.length > 0 && !scores.some(isNaN)) {
                    const sum = scores.reduce((a, b) => a + b, 0);
                    quiz = sum / scores.length;
                }
            }

            const dailyStudy = parseFloat(document.getElementById('dailyStudy').value);
            const habitSelect = document.getElementById('studyHabit');
            const habitRisk = parseFloat(habitSelect.value); 
            const habitText = habitSelect.options[habitSelect.selectedIndex].text;
            const examDateStr = document.getElementById('examDate').value;

            const errorDiv = document.getElementById('errorMessage');
            const errorText = document.getElementById('errorText');
            const resultSection = document.getElementById('resultSection');

            // --- æ–°å¢é©—è­‰é‚è¼¯ ---
            if (isNaN(target) || isNaN(past) || isNaN(quiz) || isNaN(dailyStudy) || isNaN(habitRisk) || !examDateStr) {
                errorText.innerText = "è«‹ç¢ºä¿æ‰€æœ‰æ•¸å­—æ¬„ä½å·²å¡«å¯«ï¼Œä¸”æ ¼å¼æ­£ç¢ºã€‚";
                errorDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
                return;
            }

            // 1. åˆ†æ•¸ 0-100 æª¢æŸ¥
            if (target < 0 || target > 100 || past < 0 || past > 100 || quiz < 0 || quiz > 100) {
                errorText.innerText = "æ‰€æœ‰åˆ†æ•¸å¿…é ˆä»‹æ–¼ 0 åˆ° 100 ä¹‹é–“ã€‚";
                errorDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
                return;
            }

            // 2. è®€æ›¸æ™‚é–“ 0-24 æª¢æŸ¥
            if (dailyStudy < 0 || dailyStudy > 24) {
                errorText.innerText = "ä¸€æ—¥åªæœ‰24å°æ™‚ï¼Œè®€æ›¸æ™‚é–“è«‹å¡«å¯« 0~24 ä¹‹é–“ã€‚";
                errorDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
                return;
            }

            // 3. ç›®æ¨™å¿…é ˆå¤§æ–¼ç­‰æ–¼ä¸Šæ¬¡å¤§è€ƒ
            if (target < past) {
                errorText.innerText = "è¨­å®šçš„ã€Œç›®æ¨™åˆ†æ•¸ã€ä¸å¯ä½æ–¼ã€Œä¸Šæ¬¡å¤§è€ƒåˆ†æ•¸ã€ï¼Œè«‹è¨­å®šæ›´é«˜çš„ç›®æ¨™ä¾†æŒ‘æˆ°è‡ªå·±ï¼";
                errorDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
                return;
            }

            const examDate = new Date(examDateStr);
            const now = new Date();
            now.setHours(0,0,0,0);
            
            const daysLeft = Math.ceil((examDate - now) / (1000 * 60 * 60 * 24));

            if (daysLeft < 0) {
                errorText.innerText = "è€ƒè©¦æ—¥æœŸå¿…é ˆæ˜¯ã€Œæœªä¾†ã€çš„æ—¥æœŸã€‚";
                errorDiv.classList.remove('hidden');
                resultSection.classList.add('hidden');
                return;
            }

            errorDiv.classList.add('hidden');
            resultSection.classList.remove('hidden');
            
            document.getElementById('aiResponse').classList.add('hidden');
            document.getElementById('aiResponse').innerHTML = "";
            document.getElementById('aiBtn').disabled = false;
            document.getElementById('aiBtn').classList.remove('cursor-not-allowed', 'opacity-75');

            if (currentImageBase64) {
                document.getElementById('imgStatusBadge').classList.remove('hidden');
                document.getElementById('aiPromptImgHint').classList.remove('hidden');
            } else {
                document.getElementById('imgStatusBadge').classList.add('hidden');
                document.getElementById('aiPromptImgHint').classList.add('hidden');
            }

            const scoreGap = target - past;
            let riskPast = scoreGap > 0 ? Math.min(1.0, scoreGap / 40.0) : 0;

            const quizGap = target - quiz;
            let riskQuiz = quizGap > 0 ? Math.min(1.0, quizGap / 40.0) : 0;

            let neededHours = scoreGap > 0 ? scoreGap * 2.0 : 20.0;
            const potentialHours = dailyStudy * daysLeft;
            
            let riskStudy = 0;
            if (potentialHours < neededHours) {
                riskStudy = (neededHours - potentialHours) / neededHours;
                riskStudy = Math.max(0.0, Math.min(1.0, riskStudy));
            }

            let riskTime = daysLeft < 30 ? (30 - daysLeft) / 30.0 : 0;

            const weights = { past: 0.35, quiz: 0.25, study: 0.15, habit: 0.15, time: 0.10 };
            const totalRisk = (
                riskPast * weights.past +
                riskQuiz * weights.quiz +
                riskStudy * weights.study +
                habitRisk * weights.habit +
                riskTime * weights.time
            );
            const totalScore = Math.round(totalRisk * 100);

            currentAssessmentData = {
                subject, target, past, quiz, dailyStudy, daysLeft, habitText, totalScore, scoreGap, neededHours, potentialHours
            };

            document.getElementById('resultTitle').innerText = `${subject} é¢¨éšªå ±å‘Š`;
            document.getElementById('daysLeftDisplay').innerText = daysLeft;
            document.getElementById('scoreGapDisplay').innerText = (scoreGap > 0 ? scoreGap : 0) + " åˆ†";
            document.getElementById('neededHoursDisplay').innerText = Math.round(neededHours) + " hr";
            document.getElementById('potentialHoursDisplay').innerText = Math.round(potentialHours) + " hr";
            
            const timeStatusElem = document.getElementById('timeStatusDisplay');
            if (potentialHours >= neededHours) {
                timeStatusElem.innerText = "å……è£• âœ…";
                timeStatusElem.className = "font-bold text-green-600";
            } else {
                timeStatusElem.innerText = "ä¸è¶³ âš ï¸";
                timeStatusElem.className = "font-bold text-red-600";
            }

            const riskDisplay = document.getElementById('totalRiskDisplay');
            const badge = document.getElementById('riskLevelBadge');
            const adviceElem = document.getElementById('adviceText');

            riskDisplay.innerText = totalScore + "%";
            
            let advice = "";
            let habitAdvice = "";

            if (habitRisk >= 0.9) habitAdvice = "âš ï¸ æ‚¨çš„è®€æ›¸æ•ˆç‡æ˜¯æœ€å¤§éš±æ†‚ï¼Œå»ºè­°ä½¿ç”¨ã€Œç•ªèŒ„é˜å·¥ä½œæ³•ã€ã€‚";
            else if (habitRisk >= 0.6) habitAdvice = "â„¹ï¸ è®€æ›¸å®¹æ˜“åˆ†å¿ƒï¼Œå»ºè­°ä¸‹è¼‰å°ˆæ³¨åŠ› App æˆ–åˆ°åœ–æ›¸é¤¨ã€‚";

            if (totalScore < 35) {
                riskDisplay.className = "text-4xl font-black text-green-600";
                badge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 bg-green-100 text-green-800";
                badge.innerText = "ğŸŸ¢ ä½é¢¨éšª (å®‰å…¨)";
                advice = "ç‹€æ³ä¸éŒ¯ï¼æ‚¨çš„æº–å‚™é€²åº¦ç¬¦åˆé æœŸã€‚" + (habitAdvice ? habitAdvice : "è«‹ä¿æŒç›®å‰çš„ç¯€å¥å³å¯ã€‚");
            } else if (totalScore < 65) {
                riskDisplay.className = "text-4xl font-black text-yellow-600";
                badge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 bg-yellow-100 text-yellow-800";
                badge.innerText = "ğŸŸ¡ ä¸­é¢¨éšª (éœ€æ³¨æ„)";
                advice = "æœ‰äº›å±éšªã€‚" + (habitAdvice ? habitAdvice : "å»ºè­°å¢åŠ æ¯æ—¥è®€æ›¸æ™‚é–“ï¼Œä¸¦é‡æ–°æª¢è¨å°è€ƒéŒ¯é¡Œã€‚");
            } else {
                riskDisplay.className = "text-4xl font-black text-red-600";
                badge.className = "inline-block px-3 py-1 rounded-full text-xs font-bold mt-2 bg-red-100 text-red-800";
                badge.innerText = "ğŸ”´ é«˜é¢¨éšª (å±éšª)";
                advice = "è­¦å ±ï¼ä¾ç…§ç›®å‰ç‹€æ³é›£ä»¥é”æ¨™ã€‚" + (habitAdvice ? habitAdvice : "å»ºè­°å¤§å¹…å¢åŠ æ™‚é–“æˆ–å°‹æ±‚å”åŠ©ã€‚");
            }

            adviceElem.innerText = advice;

            updateBar('barPast', 'valPast', riskPast);
            updateBar('barQuiz', 'valQuiz', riskQuiz);
            updateBar('barStudy', 'valStudy', riskStudy);
            updateBar('barHabit', 'valHabit', habitRisk);
            updateBar('barTime', 'valTime', riskTime);

            resultSection.scrollIntoView({ behavior: 'smooth' });
            
            autoSave();
        }

        function updateBar(barId, valId, riskValue) {
            const percentage = Math.round(riskValue * 100);
            document.getElementById(valId).innerText = percentage + "%";
            document.getElementById(barId).style.width = percentage + "%";
            
            const bar = document.getElementById(barId);
            bar.className = "risk-bar-fill transition-all duration-1000 ease-out";
            if (percentage < 30) bar.classList.add("bg-green-500");
            else if (percentage < 70) bar.classList.add("bg-yellow-500");
            else bar.classList.add("bg-red-500");
        }

        async function generateAIAdvice() {
            if (!currentAssessmentData) return;

            const apiKey = getApiKey();
            if (!apiKey) {
                alert("æ‚¨å°šæœªè¨­å®š API Keyï¼è«‹é»æ“Šå³ä¸Šè§’çš„è¨­å®šåœ–ç¤º (âš™ï¸) è¼¸å…¥ Keyã€‚");
                toggleModal('apiKeyModal');
                return;
            }

            const btn = document.getElementById('aiBtn');
            const btnText = document.getElementById('aiBtnText');
            const loading = document.getElementById('aiLoading');
            const loadingImgText = document.getElementById('loadingImgText');
            const responseDiv = document.getElementById('aiResponse');

            btn.disabled = true;
            btn.classList.add('cursor-not-allowed', 'opacity-75');
            btnText.classList.add('hidden');
            loading.classList.remove('hidden');
            responseDiv.classList.add('hidden');

            if (currentImageBase64) {
                loadingImgText.classList.remove('hidden');
            } else {
                loadingImgText.classList.add('hidden');
            }

            const data = currentAssessmentData;
            
            // --- æ›´æ–°å¾Œçš„ AI æŒ‡ä»¤ï¼šç›´æ¥çµ¦å»ºè­°ï¼Œçœç•¥å»¢è©± ---
            let promptText = `
ä½ æ˜¯ä¸€ä½å°ˆæ¥­çš„è€ƒè©¦æ•™ç·´ã€‚è«‹çœç•¥ã€Œç¾ç‹€åˆ†æã€æˆ–ã€Œä½ å¥½ã€ç­‰å®¢å¥—è©±ï¼Œç›´æ¥é‡å°å­¸ç”Ÿçš„æ•¸æ“šçµ¦å‡ºæœ€ç›´æ¥çš„ã€Œè¡Œå‹•æŒ‡ä»¤ã€èˆ‡ã€Œè¤‡ç¿’ç­–ç•¥ã€ã€‚è«‹ç”¨ç¹é«”ä¸­æ–‡ã€‚

å­¸ç”Ÿæ•¸æ“šï¼š
- ç§‘ç›®ï¼š${data.subject}
- ç›®æ¨™åˆ†æ•¸ï¼š${data.target}
- ç›®å‰ç¨‹åº¦ï¼šä¸Šæ¬¡å¤§è€ƒ ${data.past} åˆ†ï¼Œå¹³æ™‚å°è€ƒå¹³å‡ ${data.quiz.toFixed(1)} åˆ†
- å‰©é¤˜æ™‚é–“ï¼š${data.daysLeft} å¤©
- è®€æ›¸æŠ•å…¥ï¼šæ¯æ—¥ ${data.dailyStudy} å°æ™‚
- è®€æ›¸ç¿’æ…£ï¼š${data.habitText}
- é¢¨éšªæŒ‡æ•¸ï¼š${data.totalScore}%

è«‹æä¾›ä»¥ä¸‹å…§å®¹ï¼ˆä½¿ç”¨ Markdown åˆ—è¡¨ï¼‰ï¼š
1. **æ ¸å¿ƒç­–ç•¥**ï¼šç›´æ¥å‘Šè¨´ä»–ç¾åœ¨è©²åšä»€éº¼ï¼ˆä¾‹å¦‚ï¼šåˆ·é¡Œã€èƒŒå–®å­—ã€æˆ–æ”¾æ£„é›£é¡Œï¼‰ã€‚
2. **é‡å°æ€§è¤‡ç¿’**ï¼šé‡å° ${data.subject} çš„ç‰¹æ€§ï¼Œåˆ—å‡º 2-3 å€‹å¿…è®€é‡é»ã€‚
3. **æ™‚é–“ç®¡ç†**ï¼šå‰©é¤˜ ${data.daysLeft} å¤©ï¼Œå…·é«”å¦‚ä½•åˆ†é…è¤‡ç¿’æ¯”é‡ï¼Ÿ
4. **æ•™ç·´çš„ä¸€å¥è©±**ï¼šä¸€å¥æ¿€å‹µçš„è©±ã€‚
`;

            if (currentImageBase64) {
                promptText += `\n\n[ç‰¹åˆ¥æ³¨æ„] å­¸ç”Ÿä¸Šå‚³äº†ä¸€å¼µéŒ¯é¡Œåœ–ç‰‡ã€‚è«‹é‡å°é€™å¼µåœ–ç‰‡ï¼š
5. **éŒ¯é¡Œè¨ºæ–·èˆ‡è¤‡ç¿’**ï¼š
   - **è§€å¿µ**ï¼šé€™é¡Œè€ƒä»€éº¼ï¼Ÿ
   - **è§£æ³•**ï¼šè§£é¡Œé—œéµæ˜¯ä»€éº¼ï¼Ÿ
   - **è¤‡ç¿’**ï¼šå›å»çœ‹èª²æœ¬å“ªè£¡ï¼Ÿ`;
            }

            const parts = [{ text: promptText }];
            if (currentImageBase64) {
                parts.push({
                    inlineData: {
                        mimeType: currentImageMimeType,
                        data: currentImageBase64
                    }
                });
            }

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: parts
                        }]
                    })
                });

                const result = await response.json();
                
                if (result.error) {
                    throw new Error(result.error.message);
                }

                const aiText = result.candidates[0].content.parts[0].text;
                
                const formattedText = aiText
                    .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                    .replace(/\n/g, '<br>');

                responseDiv.innerHTML = formattedText;
                responseDiv.classList.remove('hidden');

            } catch (error) {
                responseDiv.innerHTML = `<p class="text-red-600 font-bold">AI é€£ç·šéŒ¯èª¤ã€‚è«‹æª¢æŸ¥æ‚¨çš„ API Key æ˜¯å¦æ­£ç¢ºã€‚</p><p class="text-xs text-red-400 mt-2">${error.message}</p>`;
                responseDiv.classList.remove('hidden');
            } finally {
                btn.disabled = false;
                btn.classList.remove('cursor-not-allowed', 'opacity-75');
                btnText.classList.remove('hidden');
                loading.classList.add('hidden');
            }
        }

        function resetAssessment() {
            document.getElementById('subject').value = "æ•¸å­¸";
            document.getElementById('targetScore').value = "";
            document.getElementById('pastScore').value = "";
            document.getElementById('quizScore').value = "";
            document.getElementById('dailyStudy').value = "";
            document.getElementById('studyHabit').value = "0.6"; 
            
            const today = new Date();
            const futureDate = new Date(today);
            futureDate.setDate(today.getDate() + 30);
            document.getElementById('examDate').valueAsDate = futureDate;
            
            clearImage();

            document.getElementById('resultSection').classList.add('hidden');
            document.getElementById('errorMessage').classList.add('hidden');
            document.getElementById('aiResponse').classList.add('hidden');

            currentAssessmentData = null;

            localStorage.removeItem('exam_risk_data'); 
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
